<!DOCTYPE html>
<html lang="en">

  {% include head.html %}
  <style>
    /* Styles from shihgptmd.html */
    body { font-family: sans-serif; /* Existing body styles might be in main.css */ }
    .shihgptmd-container { max-width: 900px; margin: 20px auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }
    .hidden { display: none !important; } /* Added !important to ensure override */
    .shihgptmd-container label { display: block; margin-top: 10px; margin-bottom: 5px; font-weight: bold; }
    .shihgptmd-container textarea, .shihgptmd-container select { width: 100%; padding: 8px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
    .shihgptmd-container button { padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .shihgptmd-container button:hover { background-color: #0056b3; }
    .text-hidden-on-white { color: white !important; background-color: white !important; border-color: white !important; }
    #mainOutputArea, #patientInfoInput, #epicSmartPhraseInput { min-height: 150px; }
    .checkbox-area label { font-weight: normal; display: inline-block; margin-right: 15px;}
    .section-title { margin-top: 20px; margin-bottom:10px; font-size: 1.2em; border-bottom: 1px solid #eee; padding-bottom: 5px;}

    /* Styles for condensed checkboxes and Apple-style switches */
    #checkboxOptionsContainer div.checkbox-option-item { /* Target divs wrapping each checkbox and label */
        display: inline-flex; /* Allow multiple items per line, align items within */
        align-items: center; /* Vertically align items in the center */
        margin-right: 15px; /* Space between options on the same line */
        margin-bottom: 5px; /* Space between lines of options */
    }
    #checkboxOptionsContainer input[type="checkbox"] {
        margin-right: 5px; /* Space between checkbox and its label */
    }
    #checkboxOptionsContainer h4 {
      margin-top: 10px; /* Less space above group titles */
      margin-bottom: 3px;
    }

    /* Basic Apple-style switch CSS */
    .apple-switch-label {
        position: relative;
        display: inline-block;
        width: 50px; /* Width of the switch */
        height: 28px; /* Height of the switch */
        margin-left: 10px;
    }
    .apple-switch-checkbox {
        opacity: 0;
        width: 0;
        height: 0;
    }
    .apple-switch-label::before { /* The track */
        content: "";
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 28px;
    }
    .apple-switch-label::after { /* The slider */
        content: "";
        position: absolute;
        height: 20px;
        width: 20px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }
    .apple-switch-checkbox:checked + .apple-switch-label::before {
        background-color: #2196F3; /* Blue when checked */
    }
    .apple-switch-checkbox:checked + .apple-switch-label::after { /* Corrected typo: apple_switch-label to apple-switch-label */
        transform: translateX(22px); /* Move slider to the right */
    }
    /* For the Incognito switch, we need to associate the label correctly */
    /* The Incognito checkbox itself is now .apple-switch-checkbox */
    /* The label for it needs to be styled as the switch visual */
    label[for="hideTextCheckbox"].apple-switch-label { /* More specific selector for the Incognito label */
        /* Uses the general .apple-switch-label styles above */
        /* We might need to adjust the "Incognito" text positioning if it's separate */
    }
     /* Adjusting the Incognito label text to be next to the switch */
    .checkbox-area { display: flex; align-items: center; margin-bottom: 15px;}
    .checkbox-area > label[for="hideTextCheckbox"] { /* This is the "Incognito" text */
        font-weight: bold; /* Make it like other labels */
        margin-right: 8px; /* Space before the switch */
        order: -1; /* Place text before the visual switch if checkbox is after */
    }
     /* If the "Incognito" text is part of the visual switch label, this might need adjustment */
     /* The current HTML has <input> then <label class="apple-switch-label">Incognito</label> */
     /* This means the "Incognito" text is *part* of the switch. Let's adjust that. */
     /* We'll make the visual switch label empty and put "Incognito" text before it. */

  </style>

  <body>
    <nav class="nav">
      <div class="nav-container">
        <a href="{{ site.baseurl }}/">
          <h2 class="nav-title">{{ site.title }}</h2>
        </a>
        <div class="password-entry-container">
          <input type="password" id="secret-password" placeholder="Password">
          <button onclick="checkPassword()">Enter</button>
        </div>
        <ul>
          <li class="nav-link-about"><a href="{{ '/' | prepend: site.baseurl }}">About</a></li>
          <li><a href="{{ '/portfolio' | prepend: site.baseurl }}/">Fun Stuff</a></li>
        </ul>
    </div>
  </nav>

    <main id="mainPageContent">
      {{ content }}
    </main>

    <div id="shihGptMdAppContainer" class="shihgptmd-container hidden">
        <h1>Rosetta</h1>

        <div class="checkbox-area">
            <label for="hideTextCheckbox" style="font-weight: bold; margin-right: 8px;">Incognito</label> 
            <input type="checkbox" id="hideTextCheckbox" name="hideTextCheckbox" class="apple-switch-checkbox">
            <label for="hideTextCheckbox" class="apple-switch-label" aria-hidden="true" style="width: 50px; height: 28px;"></label> <!-- Corrected class.bind and removed comment -->
        </div>

        <h2 class="section-title">Input</h2>
        <textarea id="patientInfoInput" placeholder="Enter patient information here..."></textarea>

        <h2 class="section-title">SmartPhrase Template (Optional)</h2>
        <textarea id="epicSmartPhraseInput" placeholder="Paste SmartPhrase template here if desired..."></textarea>

        <h2 class="section-title">Note Options</h2>
        <label for="templateSelector">Select Predefined Template:</label>
        <select id="templateSelector">
            <option value="general_soap">General SOAP Note</option>
            <option value="ob_l_d">OB L&D</option>
            <option value="derm_lesion">Derm Lesion</option>
            <option value="peds_well_visit">Peds Well Visit</option>
            <!-- Add more templates as needed -->
        </select>

        <h3>Checkbox Options:</h3>
        <div id="checkboxOptionsContainer" style="margin-bottom: 20px;">
            <!-- Checkboxes will be dynamically added here by JS -->
        </div>

        <button id="generatePromptButton" style="margin-top:20px;">Generate Output</button>

        <h2 class="section-title">Output</h2>
        <textarea id="mainOutputArea" placeholder="Output will appear here..." readonly></textarea>
        
        <h2 class="section-title">History <button id="refreshDriveButton" style="font-size: 0.8em; padding: 2px 5px; margin-left: 10px;">Refresh</button></h2>
        <div id="googleDriveEmbed" style="width: 100%; height: 400px; border: 1px solid #ddd; margin-top: 10px;">
            <iframe id="driveFrame" src="https://drive.google.com/embeddedfolderview?id=1-LufS-8PJEmyf79vvG6kxFw9uEKq_u3S#list" style="width:100%; height:100%; border:0;"></iframe>
        </div>
    </div>

    <footer>
      <span>
        &copy;  {{ site.author.name }} <time datetime="{{ site.time }}">{{ site.time | date: '%Y' }}</time>
      </span>
    </footer>

    <script>
      function checkPassword() {
        const passwordInput = document.getElementById('secret-password');
        const password = passwordInput.value;
        const correctPassword = 'E916!'; // Keep this password or change as needed

        if (password === correctPassword) {
          // Hide main page content and show ShihGPTMD app
          document.getElementById('mainPageContent').classList.add('hidden');
          document.getElementById('shihGptMdAppContainer').classList.remove('hidden');
          // Optionally hide the password input area itself
          // document.querySelector('.password-entry-container').classList.add('hidden');
          initializeShihGptMdApp(); // Call to initialize app features
        } else {
          alert('Incorrect password.');
        }
        passwordInput.value = ''; 
      }

      document.getElementById('secret-password').addEventListener('keypress', function(event) {
        if (event.key === 'Enter') {
          event.preventDefault(); 
          checkPassword();
        }
      });

      // ShihGPTMD App JavaScript
      function initializeShihGptMdApp() {
        const checkboxOptions = [
            // Concise Labels
            { id: "genSHN", label: "SHN", group: "Output Format" },
            { id: "genVSHN", label: "VSHN", group: "Output Format" },
            { id: "incPathophys", label: "Pathophysiology", group: "Reasoning Detail" },
            { id: "incGuidelines", label: "Guideline Citations", group: "Reasoning Detail" },
            { id: "expectImage", label: "Image Input", group: "Data Type Emphasis" },
            { id: "expectAudio", label: "Audio Input", group: "Data Type Emphasis" },
            { id: "expectStructured", label: "Structured Vitals/Labs", group: "Data Type Emphasis" },
            { id: "formatSOAP", label: "SOAP", group: "Documentation Type", checked: true },
            { id: "formatHnP", label: "H&P", group: "Documentation Type" },
            { id: "formatDischarge", label: "Discharge Summary", group: "Documentation Type" },
            { id: "formatPreOp", label: "Pre-op Note", group: "Documentation Type" },
            { id: "specOBGYN", label: "OB/GYN", group: "Specialty Context" },
            { id: "specDerm", label: "Derm", group: "Specialty Context" },
            { id: "specPeds", label: "Peds", group: "Specialty Context" },
            { id: "specOrtho", label: "Ortho", group: "Specialty Context" },
            { id: "specIM", label: "Internal Med", group: "Specialty Context" },
            { id: "incMissingData", label: "Missing Data Checklist", group: "Output Features" },
            { id: "genPatientQuestions", label: "Initial Patient Questions", group: "Output Features" },
            { id: "incTTS", label: "TTS Audio Output", group: "Output Features" },
            { id: "confirmDeidentified", label: "De-identified Data", group: "Redaction", checked: true },
            { id: "removeDates", label: "Relative Time", group: "Redaction" },
            { id: "stripNonStandardAbbr", label: "Standard Abbrev. Only", group: "Redaction" }
        ];

        function populateCheckboxOptions() {
            const container = document.getElementById('checkboxOptionsContainer');
            if (!container) return;
            container.innerHTML = ''; 
            let currentGroup = "";
            checkboxOptions.forEach(opt => {
                if (opt.group !== currentGroup) {
                    currentGroup = opt.group;
                    const groupTitle = document.createElement('h4');
                    groupTitle.textContent = currentGroup;
                    groupTitle.style.marginTop = '15px';
                    groupTitle.style.marginBottom = '5px';
                    container.appendChild(groupTitle);
                }
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = opt.id;
                checkbox.name = opt.id;
                checkbox.value = opt.id;
                if (opt.checked) {
                    checkbox.checked = true;
                }

                const labelEl = document.createElement('label');
                labelEl.htmlFor = opt.id;
                labelEl.appendChild(document.createTextNode(opt.label));
                labelEl.style.fontWeight = 'normal';
                labelEl.style.marginLeft = '5px';
                labelEl.style.marginRight = '15px';

                const div = document.createElement('div');
                div.className = 'checkbox-option-item'; // Add class for styling
                div.appendChild(checkbox);
                div.appendChild(labelEl);
                container.appendChild(div);
            });
        }

        function getSelectedServiceAbbreviation() {
            // Attempt to infer from specialty checkboxes. This is a simple inference.
            // You might want a more explicit way to set this (e.g., a dedicated input or dropdown for filename service).
            const specialtyCheckboxes = [
                { id: "specOBGYN", abbr: "OBGYN" },
                { id: "specDerm", abbr: "DERM" },
                { id: "specPeds", abbr: "PEDS" },
                { id: "specOrtho", abbr: "ORTHO" },
                { id: "specIM", abbr: "IM" }
            ];
            for (const spec of specialtyCheckboxes) {
                const checkbox = document.getElementById(spec.id);
                if (checkbox && checkbox.checked) {
                    return spec.abbr;
                }
            }
            return "GENERAL"; // Default if no specific specialty is checked
        }

        async function submitPromptToBackend() {
            const patientInfo = document.getElementById('patientInfoInput').value;
            const epicSmartPhrase = document.getElementById('epicSmartPhraseInput').value;
            const selectedTemplate = document.getElementById('templateSelector').value;
            const outputArea = document.getElementById('mainOutputArea');
            
            if (!outputArea) {
                console.error("Output area not found!");
                alert("Error: Output area not found on the page.");
                return;
            }

            outputArea.value = "Constructing dynamic prompt for backend...";

            // Construct a much shorter "dynamic prompt" for the backend
            let dynamic_prompt = `Patient Information:\n---\n${patientInfo}\n---\n`;

            if (epicSmartPhrase.trim() !== "") {
                dynamic_prompt += `\nUse EPIC SmartPhrase Template for output format:\n---\n${epicSmartPhrase}\n---\n`;
            } else {
                dynamic_prompt += `\nUse Predefined Template: ${selectedTemplate}\n`;
            }

            dynamic_prompt += "\nUser-Selected Options for this request:\n";
            let hasSelectedOption = false;
            checkboxOptions.forEach(opt => { // checkboxOptions should be accessible here
                const checkbox = document.getElementById(opt.id);
                if (checkbox && checkbox.checked) {
                    dynamic_prompt += `- ${opt.label}\n`;
                    hasSelectedOption = true;
                }
            });
            if (!hasSelectedOption) {
                dynamic_prompt += "- (Using default behaviors as per core instructions for non-specified options)\n";
            }
            dynamic_prompt += "\n--- END OF DYNAMIC REQUEST ---";
            
            const serviceAbbreviation = getSelectedServiceAbbreviation();
            outputArea.value = `Sending dynamic prompt to backend for service: ${serviceAbbreviation}... Please wait.`;

            try {
                const backend_response = await fetch('http://10.0.0.208:5000/generate_note', { // Updated to local IP
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        prompt: dynamic_prompt, // Send the shorter, dynamic prompt
                        service_abbreviation: serviceAbbreviation
                    }),
                });

                const result = await backend_response.json();
                let resultDisplay = "";

                if (result.prompt_feedback && result.prompt_feedback !== "N/A") {
                    resultDisplay += `Prompt Feedback from API:\n${result.prompt_feedback}\n\n---\n`;
                }

                if (backend_response.ok) {
                    resultDisplay += `Success from backend:\nFilename: ${result.filename}\nMessage: ${result.message}\n\nLLM Response:\n---\n${result.llm_response}`;
                } else {
                    resultDisplay += `Error from backend: ${result.error}\nDetails: ${result.details || 'N/A'}`;
                }
                outputArea.value = resultDisplay;

            } catch (error) {
                console.error('Error sending prompt to backend:', error);
                outputArea.value = `Network error or backend server not running.\nCould not connect to the ShihGPT-MD backend at http://10.0.0.208:5000.\nPlease ensure the Python Flask server (shihgptmd_backend.py) is running and accessible on your network (check firewall).\nDetails: ${error.message}`;
            }
        }
        
        const hideCheckbox = document.getElementById('hideTextCheckbox');
        const textAreasToHide = [
            document.getElementById('patientInfoInput'),
            document.getElementById('epicSmartPhraseInput'),
            document.getElementById('mainOutputArea')
        ];

        if (hideCheckbox) {
            hideCheckbox.addEventListener('change', function() {
                textAreasToHide.forEach(textArea => {
                    if (textArea) {
                        if (this.checked) {
                            textArea.classList.add('text-hidden-on-white');
                        } else {
                            textArea.classList.remove('text-hidden-on-white');
                        }
                    }
                });
            });
        }

        populateCheckboxOptions(); // This function should be defined within initializeShihGptMdApp or globally accessible

        const generateButton = document.getElementById('generatePromptButton');
        if (generateButton) {
            generateButton.addEventListener('click', submitPromptToBackend); 
        }

        const refreshDriveButton = document.getElementById('refreshDriveButton');
        if (refreshDriveButton) {
            refreshDriveButton.addEventListener('click', function() {
                const driveFrame = document.getElementById('driveFrame');
                if (driveFrame) {
                    outputArea.value = "Refreshing History view..."; // Show some feedback
                    const originalSrc = driveFrame.src;
                    driveFrame.src = ''; // Clear src
                    setTimeout(() => { // Delay to ensure change is registered
                        driveFrame.src = originalSrc; // Re-assign src to force reload
                         if(outputArea.value === "Refreshing History view...") {
                            outputArea.value = "History view refreshed (or refresh attempted).";
                         }
                    }, 100);
                }
            });
        }

        console.log("ShihGPTMD app features ready to be initialized upon password success.");
      }
      // Call initializeShihGptMdApp() only after successful password entry,
      // which is handled in the modified checkPassword function.
      // Ensure checkboxOptions is defined in a scope accessible by submitPromptToBackend if it's called from initializeShihGptMdApp
      // For simplicity, ensure checkboxOptions is defined before initializeShihGptMdApp or within it if not already.
      // It seems checkboxOptions is defined globally in the previous version of this script, which is fine.
    </script>
  </body>
</html>
